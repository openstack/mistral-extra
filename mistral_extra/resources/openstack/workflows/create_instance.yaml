---
version: '2.0'

create_instance:
  type: direct

  description: |
    Creates instance and waits till instance OS is up and running.

  input:
    - name
    - image
    - flavor
    - keypair
    - network

  output:
    id: <% $.vm_id %>
    name: <% $.name %>
    status: <% $.status %>

  tasks:
    get_image:
      description: Get image ID from name
      action: glance.images_list
      input:
        name: <% $.image %>
      publish:
        image_id: <% task().result[0].id %>
      on-success:
        - create_vm

    get_flavor:
      description: Get flavor ID from name
      action: nova.flavors_find
      input:
        name: <% $.flavor %>
      publish:
        flavor_id: <% task().result.id %>
      on-success:
        - create_vm

    get_network:
      description: Get network ID from name
      action: neutron.list_networks
      input:
        name: <% $.network %>
      publish:
        network_id: <% task().result.networks[0].id %>
      on-success:
        - create_vm

    create_vm:
      join: all
      description: Create an instance
      action: nova.servers_create name=<% $.name %> image=<% $.image_id %> flavor=<% $.flavor_id %>
      input:
        name: <% $.name %>
        image: <% $.image_id %>
        flavor: <% $.flavor_id %>
        key_name: <% $.keypair %>
        nics: [{ "net-id": <% $.network_id %> }]
      publish:
        vm_id: <% task(create_vm).result.id %>
      on-success:
        - wait_vm_active

    wait_vm_active:
      description: Waits till instance is ACTIVE.
      action: nova.servers_find id=<% $.vm_id %> status="ACTIVE"
      retry:
        count: 10
        delay: 10
      publish:
        status: <% task(wait_vm_active).result.status %>
